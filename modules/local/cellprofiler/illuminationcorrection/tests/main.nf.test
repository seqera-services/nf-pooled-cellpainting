nextflow_process {

    name "Test Process CELLPROFILER_ILLUMINATIONCORRECTION"
    script "../main.nf"
    process "CELLPROFILER_ILLUMINATIONCORRECTION"

    tag "cellprofiler"
    tag "cellprofiler/illuminationcorrection"

    test("cellprofiler - illuminationcorrection - multi-channel - not parallel") {

        when {
            params {
                cp_multichannel_parallel = false
            }
            process {
                """
                input[0] = [
                    [batch:'Batch1', plate:'Plate1', channels:'CHN2-AF488', id:'Batch1_Plate1_CHN2-AF488'], 'CHN2-AF488',
                    [   file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0000_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0000.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0001_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0001.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0002_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0002.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0003_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0003.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA2_PointA2_0000_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq1025.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA2_PointA2_0001_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq1026.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA2_PointA2_0002_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq1027.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA2_PointA2_0003_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq1028.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellB1_PointB1_0000_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq3075.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellB1_PointB1_0001_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq3076.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellB1_PointB1_0002_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq3077.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellB1_PointB1_0003_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq3078.ome.tiff")],
                        file("${projectDir}/modules/local/cellprofiler/illuminationcorrection/tests/load_data.csv", checkIfExists: true)
                ]
                input[1] = "${projectDir}/assets/cellprofiler/illumination.cppipe.template"
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out.illumination_corrections).match() }
            )
        }

    }

        test("cellprofiler - illuminationcorrection - multi-channel - in parallel") {

        when {
            params {
                cp_multichannel_parallel = true
            }
            process {
                """
                input[0] = [
                    [batch:'Batch1', plate:'Plate1', channels:'CHN2-AF488', id:'Batch1_Plate1_CHN2-AF488'], 'CHN2-AF488',
                    [   file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0000_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0000.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0001_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0001.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0002_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0002.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0003_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0003.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA2_PointA2_0000_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq1025.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA2_PointA2_0001_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq1026.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA2_PointA2_0002_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq1027.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA2_PointA2_0003_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq1028.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellB1_PointB1_0000_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq3075.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellB1_PointB1_0001_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq3076.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellB1_PointB1_0002_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq3077.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellB1_PointB1_0003_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq3078.ome.tiff")],
                        file("${projectDir}/modules/local/cellprofiler/illuminationcorrection/tests/load_data.csv", checkIfExists: true)
                ]
                input[1] = "${projectDir}/assets/cellprofiler/illumination.cppipe.template"
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out.illumination_corrections).match() }
            )
        }

    }

    test("cellprofiler - illuminationcorrection - stub") {

        options "-stub"

        when {
            process {
                """
                input[0] = [
                    [batch:'Batch1', plate:'Plate1', channels:'CHN2-AF488', id:'Batch1_Plate1_CHN2-AF488'], 'CHN2-AF488',
                    [   file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0000_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0000.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0001_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0001.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0002_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0002.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA1_PointA1_0003_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq0003.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA2_PointA2_0000_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq1025.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA2_PointA2_0001_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq1026.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA2_PointA2_0002_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq1027.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellA2_PointA2_0003_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq1028.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellB1_PointB1_0000_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq3075.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellB1_PointB1_0001_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq3076.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellB1_PointB1_0002_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq3077.ome.tiff"),
                        file("s3://nf-pooled-cellpainting-sandbox/data/test-data/fix-s1/Source1/Batch1/images/Plate1/20X_CP_Plate1_20240319_122800_179/WellB1_PointB1_0003_ChannelPhalloAF750,CHN2-AF488,DAPI_Seq3078.ome.tiff")],
                        file("${projectDir}/modules/local/cellprofiler/illuminationcorrection/tests/load_data.csv", checkIfExists: true)
                ]
                input[1] = "${projectDir}/assets/cellprofiler/illumination.cppipe.template"
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out).match() }
            )
        }

    }

}
